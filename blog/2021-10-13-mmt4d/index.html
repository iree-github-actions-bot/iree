
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://google.github.io/iree/blog/2021-10-13-mmt4d/">
      
      <link rel="icon" href="../../ghost.svg">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Work in progress on Matrix Multiplication on CPU - IREE</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#work-in-progress-on-matrix-multiplication-on-cpu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="IREE" class="md-header__button md-logo" aria-label="IREE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 128 128"><defs/><symbol id="h" viewBox="-64.5 -64.5 129 129"><g fill="none" stroke="#4285f4" stroke-miterlimit="10"><rect width="128" height="128" x="-64" y="-64"/><path d="M36.95 37.82C27.32 46.32 14.2 51 0 51c-14.27 0-27.39-4.62-36.96-13.01C-47.45 28.79-53 15.65-53 0c0-15.58 5.55-28.69 16.04-37.92C-27.36-46.35-14.24-51 0-51c14.17 0 27.29 4.71 36.95 13.25C47.45-28.45 53-15.4 53 0c0 15.47-5.55 28.55-16.05 37.82z"/><path d="M0 55h0c-29.59 0-57-19.01-57-55 0-35.8 27.41-55 57-55h0c29.59 0 57 19.69 57 55 0 35.51-27.41 55-57 55z"/><path d="M0-43c-12.29 0-23.54 3.94-31.68 11.09C-40.39-24.25-45-13.21-45 0c0 29.7 22.6 43 45 43 21.67 0 45-13.46 45-43S21.67-43 0-43h0z"/><line x1="-.01" x2="-.01" y1="51" y2="-51"/><line x1="-16" x2="-16" y1="48.95" y2="-48.93"/><line x1="15.99" x2="15.99" y1="48.91" y2="-48.93"/><line x1="53" x2="-53" y1=".08" y2=".08"/></g></symbol><linearGradient id="a" x1="64.0003" x2="64.0003" y1="8.5308" y2="121.1266" gradientUnits="userSpaceOnUse"><stop offset=".00131497" stop-color="#c7c7c7"/><stop offset=".2797" stop-color="#cacaca"/><stop offset=".5253" stop-color="#d5d5d5"/><stop offset=".7578" stop-color="#e7e7e7"/><stop offset=".9473" stop-color="#fcfcfc"/></linearGradient><path fill="url(#a)" d="M101.04 122.77c-1 0-3.35-1.25-5.43-2.36-3.88-2.06-8.72-4.63-13.51-4.63-4.25 0-7.42 2.02-10.22 3.8-2.51 1.6-4.88 3.11-7.87 3.17-3.22-.06-5.61-1.61-8.15-3.26-2.82-1.83-5.73-3.72-9.92-3.72-4.79 0-9.65 2.57-13.55 4.63-2.09 1.11-4.47 2.36-5.47 2.36-1.21 0-3.23-1.01-3.34-1.54.02-.07.05-.18.07-.25.02-.1 2.12-10.3 3.82-20.52 3.69-22.18 2.06-22.84.33-23.55C16.17 72.16 5.14 55.19 5.4 46c.05-1.97.79-4.08 1.95-4.2.09-.01.17-.02.25-.02.33 0 .44.05 1.44 1.3.6.75 1.34 1.67 2.44 2.74 5.12 4.96 9.32 7.17 16.01 8.45.13.02.25.04.38.04.46 0 .91-.16 1.27-.46.46-.38.73-.95.73-1.54V38.6c0-8.28 3.45-16.52 9.48-22.6 6.39-6.45 15.1-10 24.54-10 18.64 0 34.38 14.93 34.38 32.6v13.71c0 .61.28 1.19.75 1.56.36.28.8.44 1.25.44.15 0 .3-.02.45-.05 6.47-1.49 11.37-4.09 15.87-8.44 1.11-1.07 1.85-2.01 2.45-2.76 1.01-1.28 1.09-1.28 1.4-1.28.08 0 .16.01.24.01 1.15.12 1.88 2.23 1.93 4.19.24 9.2-10.8 26.17-22.43 30.93-1.73.71-3.36 1.37.33 23.55 1.7 10.22 3.8 20.42 3.82 20.52.01.07.03.13.05.2-.1.58-2.12 1.59-3.34 1.59z"/><path fill="#a1a1a1" d="M63.87 8c17.55 0 32.38 14.01 32.38 30.6v13.71c0 1.22.56 2.37 1.51 3.13.71.57 1.6.87 2.49.87.3 0 .6-.03.9-.1 6.85-1.57 12.03-4.34 16.81-8.95 1.09-1.05 1.86-1.99 2.44-2.72.11.41.19.92.21 1.5.12 4.4-2.47 10.6-6.93 16.6-4.33 5.83-9.8 10.59-14.26 12.42-3.44 1.4-4.48 4.12-.88 25.73 1.41 8.45 3.08 16.88 3.64 19.65-.38.17-.83.3-1.09.33-.79-.13-2.95-1.28-4.53-2.12-4.08-2.17-9.16-4.86-14.45-4.86-4.83 0-8.26 2.19-11.29 4.12-2.34 1.49-4.37 2.78-6.75 2.86-2.68-.07-4.63-1.34-7.1-2.94-2.92-1.89-6.23-4.04-11.01-4.04-5.29 0-10.39 2.69-14.49 4.86-1.59.84-3.76 1.99-4.56 2.12-.27-.03-.72-.16-1.09-.32.56-2.77 2.24-11.2 3.64-19.65 3.6-21.61 2.55-24.33-.89-25.73-4.46-1.82-9.92-6.58-14.25-12.42-4.45-6-7.04-12.21-6.92-16.61.02-.6.1-1.12.22-1.53.58.73 1.37 1.69 2.47 2.74 5.45 5.27 9.9 7.62 17.03 8.98.25.05.5.07.75.07.92 0 1.83-.32 2.55-.92.92-.76 1.45-1.89 1.45-3.08V38.6c0-7.76 3.24-15.48 8.9-21.19C46.76 11.34 54.97 8 63.87 8m0-4c-21.2 0-36.01 16.72-36.01 34.6v13.71c-6.58-1.26-10.31-3.39-15-7.93-2.83-2.72-3.15-4.6-5.27-4.6-.14 0-.29.01-.45.03-2.61.27-3.67 3.51-3.74 6.13-.32 11.52 12.98 28.46 23.65 32.83 3.02 1.23-5.35 41.81-5.35 41.81-.83 2.61 3.43 4.19 5.23 4.19 3.62 0 11.7-6.99 19.02-6.99 7.24 0 10.43 6.83 18.11 6.98 7.16-.14 10.79-6.98 18.04-6.98 7.32 0 15.32 6.99 18.94 6.99 1.81 0 6.07-1.58 5.24-4.19 0 0-8.36-40.58-5.35-41.81 10.67-4.37 23.98-21.31 23.67-32.83-.07-2.62-1.12-5.86-3.72-6.13-.16-.02-.31-.03-.46-.03-2.13 0-2.42 1.88-5.24 4.6-4.71 4.54-9.45 6.67-14.93 7.93V38.6c0-18.18-15.9-34.6-36.38-34.6z"/><g><defs><path id="b" d="M63.99 61.7c-9.51 0-18.34-.8-25.72-2.16-1.83-.34-3.45 1.27-3.07 3.09 2.45 11.99 14.25 21.84 28.78 21.84 15.9 0 26.6-10.17 28.82-21.88.34-1.81-1.27-3.39-3.08-3.05-7.37 1.36-16.21 2.16-25.73 2.16z"/></defs><clipPath id="c"><use overflow="visible" xlink:href="#b"/></clipPath><path fill="#242424" d="M63.99 61.7c-9.51 0-18.34-.8-25.72-2.16-1.83-.34-3.45 1.27-3.07 3.09 2.45 11.99 14.25 21.84 28.78 21.84 15.9 0 26.6-10.17 28.82-21.88.34-1.81-1.27-3.39-3.08-3.05-7.37 1.36-16.21 2.16-25.73 2.16z" clip-path="url(#c)"/><g clip-path="url(#c)" opacity=".2"><path d="M89.74 62.58c-1.09 5.04-3.96 9.64-8.11 13-4.74 3.85-10.84 5.88-17.65 5.88-12.26 0-23.21-8.08-25.72-18.88 7.69 1.38 16.57 2.11 25.73 2.11 9.17.01 18.06-.72 25.75-2.11m.47-3.09c-.16 0-.32.01-.49.05-7.37 1.37-16.22 2.16-25.73 2.16-9.51 0-18.34-.8-25.72-2.16-.17-.03-.33-.05-.49-.05-1.61 0-2.92 1.48-2.58 3.14 2.45 11.99 14.25 21.84 28.78 21.84 15.9 0 26.6-10.17 28.82-21.88.31-1.65-.99-3.1-2.59-3.1z"/></g><path fill="none" d="M63.99 61.7c-9.51 0-18.34-.8-25.72-2.16-1.83-.34-3.45 1.27-3.07 3.09 2.45 11.99 14.25 21.84 28.78 21.84 15.9 0 26.6-10.17 28.82-21.88.34-1.81-1.27-3.39-3.08-3.05-7.37 1.36-16.21 2.16-25.73 2.16z"/><g><defs><path id="d" d="M38.28 63.14v33.01h50.87V63.14c-7.57 1.31-16.23 2.01-25.16 2.01-8.91 0-17.57-.69-25.13-2"/></defs><clipPath id="e"><use overflow="visible" xlink:href="#d"/></clipPath><path fill="#e04c74" d="M66.99 95.88h-4.91c-6.43 0-11.64-5.21-11.64-11.64v-30.2h28.19v30.2c0 6.43-5.21 11.64-11.64 11.64z" clip-path="url(#e)"/><g clip-path="url(#e)" opacity=".3"><path fill="#ab3f2e" d="M75.78 56.88v27.36c0 4.85-3.94 8.79-8.79 8.79h-4.91c-4.85 0-8.79-3.94-8.79-8.79V56.88h22.49m2.85-2.84H50.44v30.2c0 6.43 5.21 11.64 11.64 11.64h4.91c6.43 0 11.64-5.21 11.64-11.64v-30.2z"/></g><line x1="64.54" x2="64.54" y1="54.04" y2="79.56" fill="none" stroke="#ab3f2e" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3" clip-path="url(#e)" opacity=".3"/></g></g><g><circle cx="76.36" cy="41.86" r="15.81" fill="#fff"/><path fill="#a1a1a1" d="M76.36 30.06c6.51 0 11.81 5.3 11.81 11.81s-5.3 11.81-11.81 11.81c-6.51 0-11.81-5.3-11.81-11.81s5.3-11.81 11.81-11.81m0-4c-8.73 0-15.81 7.08-15.81 15.81s7.08 15.81 15.81 15.81 15.81-7.08 15.81-15.81-7.08-15.81-15.81-15.81z"/><path fill="#242424" d="M76.36 36.24c-3.06 0-5.53 1.81-5.53 5.62s2.48 5.62 5.53 5.62c3.06 0 5.53-1.81 5.53-5.62s-2.47-5.62-5.53-5.62z"/><g fill="#242424"><path d="M54.09 48.24s-.07-.03-.2-.09c-.06-.03-.14-.06-.23-.1-.06-.02-.14-.04-.22-.06-.15-.05-.41-.13-.69-.2-.27-.08-.6-.14-.96-.21-.72-.13-1.59-.21-2.54-.23-.95-.01-1.97.05-2.99.2-.19.03-.6.08-.79.12-.23.04-.46.08-.72.14-.49.11-.97.22-1.42.36-.91.28-1.72.59-2.38.91-.65.32-1.15.63-1.48.85-.16.11-.29.2-.37.27-.08.06-.13.1-.13.1l-.21.15c-.82.61-1.97.44-2.58-.38-.5-.67-.47-1.56 0-2.19 0 0 .05-.07.16-.21.1-.14.25-.35.47-.58.21-.24.48-.52.8-.8.32-.29.7-.59 1.13-.88.85-.6 1.91-1.15 3.09-1.6.59-.22 1.2-.43 1.84-.58.31-.08.65-.15.99-.22.38-.08.56-.1.95-.17 1.31-.17 2.64-.22 3.9-.11 1.25.11 2.42.35 3.41.69.49.16.94.35 1.33.54.4.18.7.37 1.01.56.15.09.28.18.39.26.08.06.15.12.2.16.11.09.17.13.17.13.8.65.93 1.82.28 2.62-.56.68-1.46.88-2.21.55z"/><path d="M53.59 47.57s-.06-.05-.16-.15c-.11-.12-.24-.21-.39-.34-.34-.28-.86-.7-1.52-1.19-.67-.48-1.47-1.04-2.36-1.61-.45-.28-.92-.57-1.39-.86-.47-.29-.99-.59-1.45-.84-.54-.31-1.01-.57-1.5-.83s-.98-.51-1.45-.75c-.95-.47-1.84-.88-2.59-1.2-.76-.32-1.38-.55-1.81-.7-.42-.13-.65-.21-.65-.21l-.19-.06c-.97-.31-1.5-1.36-1.19-2.33.26-.8 1.01-1.3 1.81-1.28 0 0 .09 0 .26.01.17 0 .42.01.72.04.61.06 1.45.19 2.41.45.96.25 2.04.61 3.15 1.07.55.24 1.13.48 1.68.76.57.28 1.16.6 1.67.87.59.34 1.11.66 1.64 1 .53.33 1.03.7 1.52 1.05.97.72 1.83 1.46 2.53 2.15.71.69 1.25 1.34 1.62 1.84.21.27.35.49.41.6.07.12.11.19.11.19.53.88.26 2.02-.62 2.56-.74.45-1.67.32-2.26-.24z"/></g></g></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IREE
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Work in progress on Matrix Multiplication on CPU
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/google/iree" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    google/iree
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="IREE" class="md-nav__button md-logo" aria-label="IREE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 128 128"><defs/><symbol id="h" viewBox="-64.5 -64.5 129 129"><g fill="none" stroke="#4285f4" stroke-miterlimit="10"><rect width="128" height="128" x="-64" y="-64"/><path d="M36.95 37.82C27.32 46.32 14.2 51 0 51c-14.27 0-27.39-4.62-36.96-13.01C-47.45 28.79-53 15.65-53 0c0-15.58 5.55-28.69 16.04-37.92C-27.36-46.35-14.24-51 0-51c14.17 0 27.29 4.71 36.95 13.25C47.45-28.45 53-15.4 53 0c0 15.47-5.55 28.55-16.05 37.82z"/><path d="M0 55h0c-29.59 0-57-19.01-57-55 0-35.8 27.41-55 57-55h0c29.59 0 57 19.69 57 55 0 35.51-27.41 55-57 55z"/><path d="M0-43c-12.29 0-23.54 3.94-31.68 11.09C-40.39-24.25-45-13.21-45 0c0 29.7 22.6 43 45 43 21.67 0 45-13.46 45-43S21.67-43 0-43h0z"/><line x1="-.01" x2="-.01" y1="51" y2="-51"/><line x1="-16" x2="-16" y1="48.95" y2="-48.93"/><line x1="15.99" x2="15.99" y1="48.91" y2="-48.93"/><line x1="53" x2="-53" y1=".08" y2=".08"/></g></symbol><linearGradient id="a" x1="64.0003" x2="64.0003" y1="8.5308" y2="121.1266" gradientUnits="userSpaceOnUse"><stop offset=".00131497" stop-color="#c7c7c7"/><stop offset=".2797" stop-color="#cacaca"/><stop offset=".5253" stop-color="#d5d5d5"/><stop offset=".7578" stop-color="#e7e7e7"/><stop offset=".9473" stop-color="#fcfcfc"/></linearGradient><path fill="url(#a)" d="M101.04 122.77c-1 0-3.35-1.25-5.43-2.36-3.88-2.06-8.72-4.63-13.51-4.63-4.25 0-7.42 2.02-10.22 3.8-2.51 1.6-4.88 3.11-7.87 3.17-3.22-.06-5.61-1.61-8.15-3.26-2.82-1.83-5.73-3.72-9.92-3.72-4.79 0-9.65 2.57-13.55 4.63-2.09 1.11-4.47 2.36-5.47 2.36-1.21 0-3.23-1.01-3.34-1.54.02-.07.05-.18.07-.25.02-.1 2.12-10.3 3.82-20.52 3.69-22.18 2.06-22.84.33-23.55C16.17 72.16 5.14 55.19 5.4 46c.05-1.97.79-4.08 1.95-4.2.09-.01.17-.02.25-.02.33 0 .44.05 1.44 1.3.6.75 1.34 1.67 2.44 2.74 5.12 4.96 9.32 7.17 16.01 8.45.13.02.25.04.38.04.46 0 .91-.16 1.27-.46.46-.38.73-.95.73-1.54V38.6c0-8.28 3.45-16.52 9.48-22.6 6.39-6.45 15.1-10 24.54-10 18.64 0 34.38 14.93 34.38 32.6v13.71c0 .61.28 1.19.75 1.56.36.28.8.44 1.25.44.15 0 .3-.02.45-.05 6.47-1.49 11.37-4.09 15.87-8.44 1.11-1.07 1.85-2.01 2.45-2.76 1.01-1.28 1.09-1.28 1.4-1.28.08 0 .16.01.24.01 1.15.12 1.88 2.23 1.93 4.19.24 9.2-10.8 26.17-22.43 30.93-1.73.71-3.36 1.37.33 23.55 1.7 10.22 3.8 20.42 3.82 20.52.01.07.03.13.05.2-.1.58-2.12 1.59-3.34 1.59z"/><path fill="#a1a1a1" d="M63.87 8c17.55 0 32.38 14.01 32.38 30.6v13.71c0 1.22.56 2.37 1.51 3.13.71.57 1.6.87 2.49.87.3 0 .6-.03.9-.1 6.85-1.57 12.03-4.34 16.81-8.95 1.09-1.05 1.86-1.99 2.44-2.72.11.41.19.92.21 1.5.12 4.4-2.47 10.6-6.93 16.6-4.33 5.83-9.8 10.59-14.26 12.42-3.44 1.4-4.48 4.12-.88 25.73 1.41 8.45 3.08 16.88 3.64 19.65-.38.17-.83.3-1.09.33-.79-.13-2.95-1.28-4.53-2.12-4.08-2.17-9.16-4.86-14.45-4.86-4.83 0-8.26 2.19-11.29 4.12-2.34 1.49-4.37 2.78-6.75 2.86-2.68-.07-4.63-1.34-7.1-2.94-2.92-1.89-6.23-4.04-11.01-4.04-5.29 0-10.39 2.69-14.49 4.86-1.59.84-3.76 1.99-4.56 2.12-.27-.03-.72-.16-1.09-.32.56-2.77 2.24-11.2 3.64-19.65 3.6-21.61 2.55-24.33-.89-25.73-4.46-1.82-9.92-6.58-14.25-12.42-4.45-6-7.04-12.21-6.92-16.61.02-.6.1-1.12.22-1.53.58.73 1.37 1.69 2.47 2.74 5.45 5.27 9.9 7.62 17.03 8.98.25.05.5.07.75.07.92 0 1.83-.32 2.55-.92.92-.76 1.45-1.89 1.45-3.08V38.6c0-7.76 3.24-15.48 8.9-21.19C46.76 11.34 54.97 8 63.87 8m0-4c-21.2 0-36.01 16.72-36.01 34.6v13.71c-6.58-1.26-10.31-3.39-15-7.93-2.83-2.72-3.15-4.6-5.27-4.6-.14 0-.29.01-.45.03-2.61.27-3.67 3.51-3.74 6.13-.32 11.52 12.98 28.46 23.65 32.83 3.02 1.23-5.35 41.81-5.35 41.81-.83 2.61 3.43 4.19 5.23 4.19 3.62 0 11.7-6.99 19.02-6.99 7.24 0 10.43 6.83 18.11 6.98 7.16-.14 10.79-6.98 18.04-6.98 7.32 0 15.32 6.99 18.94 6.99 1.81 0 6.07-1.58 5.24-4.19 0 0-8.36-40.58-5.35-41.81 10.67-4.37 23.98-21.31 23.67-32.83-.07-2.62-1.12-5.86-3.72-6.13-.16-.02-.31-.03-.46-.03-2.13 0-2.42 1.88-5.24 4.6-4.71 4.54-9.45 6.67-14.93 7.93V38.6c0-18.18-15.9-34.6-36.38-34.6z"/><g><defs><path id="b" d="M63.99 61.7c-9.51 0-18.34-.8-25.72-2.16-1.83-.34-3.45 1.27-3.07 3.09 2.45 11.99 14.25 21.84 28.78 21.84 15.9 0 26.6-10.17 28.82-21.88.34-1.81-1.27-3.39-3.08-3.05-7.37 1.36-16.21 2.16-25.73 2.16z"/></defs><clipPath id="c"><use overflow="visible" xlink:href="#b"/></clipPath><path fill="#242424" d="M63.99 61.7c-9.51 0-18.34-.8-25.72-2.16-1.83-.34-3.45 1.27-3.07 3.09 2.45 11.99 14.25 21.84 28.78 21.84 15.9 0 26.6-10.17 28.82-21.88.34-1.81-1.27-3.39-3.08-3.05-7.37 1.36-16.21 2.16-25.73 2.16z" clip-path="url(#c)"/><g clip-path="url(#c)" opacity=".2"><path d="M89.74 62.58c-1.09 5.04-3.96 9.64-8.11 13-4.74 3.85-10.84 5.88-17.65 5.88-12.26 0-23.21-8.08-25.72-18.88 7.69 1.38 16.57 2.11 25.73 2.11 9.17.01 18.06-.72 25.75-2.11m.47-3.09c-.16 0-.32.01-.49.05-7.37 1.37-16.22 2.16-25.73 2.16-9.51 0-18.34-.8-25.72-2.16-.17-.03-.33-.05-.49-.05-1.61 0-2.92 1.48-2.58 3.14 2.45 11.99 14.25 21.84 28.78 21.84 15.9 0 26.6-10.17 28.82-21.88.31-1.65-.99-3.1-2.59-3.1z"/></g><path fill="none" d="M63.99 61.7c-9.51 0-18.34-.8-25.72-2.16-1.83-.34-3.45 1.27-3.07 3.09 2.45 11.99 14.25 21.84 28.78 21.84 15.9 0 26.6-10.17 28.82-21.88.34-1.81-1.27-3.39-3.08-3.05-7.37 1.36-16.21 2.16-25.73 2.16z"/><g><defs><path id="d" d="M38.28 63.14v33.01h50.87V63.14c-7.57 1.31-16.23 2.01-25.16 2.01-8.91 0-17.57-.69-25.13-2"/></defs><clipPath id="e"><use overflow="visible" xlink:href="#d"/></clipPath><path fill="#e04c74" d="M66.99 95.88h-4.91c-6.43 0-11.64-5.21-11.64-11.64v-30.2h28.19v30.2c0 6.43-5.21 11.64-11.64 11.64z" clip-path="url(#e)"/><g clip-path="url(#e)" opacity=".3"><path fill="#ab3f2e" d="M75.78 56.88v27.36c0 4.85-3.94 8.79-8.79 8.79h-4.91c-4.85 0-8.79-3.94-8.79-8.79V56.88h22.49m2.85-2.84H50.44v30.2c0 6.43 5.21 11.64 11.64 11.64h4.91c6.43 0 11.64-5.21 11.64-11.64v-30.2z"/></g><line x1="64.54" x2="64.54" y1="54.04" y2="79.56" fill="none" stroke="#ab3f2e" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3" clip-path="url(#e)" opacity=".3"/></g></g><g><circle cx="76.36" cy="41.86" r="15.81" fill="#fff"/><path fill="#a1a1a1" d="M76.36 30.06c6.51 0 11.81 5.3 11.81 11.81s-5.3 11.81-11.81 11.81c-6.51 0-11.81-5.3-11.81-11.81s5.3-11.81 11.81-11.81m0-4c-8.73 0-15.81 7.08-15.81 15.81s7.08 15.81 15.81 15.81 15.81-7.08 15.81-15.81-7.08-15.81-15.81-15.81z"/><path fill="#242424" d="M76.36 36.24c-3.06 0-5.53 1.81-5.53 5.62s2.48 5.62 5.53 5.62c3.06 0 5.53-1.81 5.53-5.62s-2.47-5.62-5.53-5.62z"/><g fill="#242424"><path d="M54.09 48.24s-.07-.03-.2-.09c-.06-.03-.14-.06-.23-.1-.06-.02-.14-.04-.22-.06-.15-.05-.41-.13-.69-.2-.27-.08-.6-.14-.96-.21-.72-.13-1.59-.21-2.54-.23-.95-.01-1.97.05-2.99.2-.19.03-.6.08-.79.12-.23.04-.46.08-.72.14-.49.11-.97.22-1.42.36-.91.28-1.72.59-2.38.91-.65.32-1.15.63-1.48.85-.16.11-.29.2-.37.27-.08.06-.13.1-.13.1l-.21.15c-.82.61-1.97.44-2.58-.38-.5-.67-.47-1.56 0-2.19 0 0 .05-.07.16-.21.1-.14.25-.35.47-.58.21-.24.48-.52.8-.8.32-.29.7-.59 1.13-.88.85-.6 1.91-1.15 3.09-1.6.59-.22 1.2-.43 1.84-.58.31-.08.65-.15.99-.22.38-.08.56-.1.95-.17 1.31-.17 2.64-.22 3.9-.11 1.25.11 2.42.35 3.41.69.49.16.94.35 1.33.54.4.18.7.37 1.01.56.15.09.28.18.39.26.08.06.15.12.2.16.11.09.17.13.17.13.8.65.93 1.82.28 2.62-.56.68-1.46.88-2.21.55z"/><path d="M53.59 47.57s-.06-.05-.16-.15c-.11-.12-.24-.21-.39-.34-.34-.28-.86-.7-1.52-1.19-.67-.48-1.47-1.04-2.36-1.61-.45-.28-.92-.57-1.39-.86-.47-.29-.99-.59-1.45-.84-.54-.31-1.01-.57-1.5-.83s-.98-.51-1.45-.75c-.95-.47-1.84-.88-2.59-1.2-.76-.32-1.38-.55-1.81-.7-.42-.13-.65-.21-.65-.21l-.19-.06c-.97-.31-1.5-1.36-1.19-2.33.26-.8 1.01-1.3 1.81-1.28 0 0 .09 0 .26.01.17 0 .42.01.72.04.61.06 1.45.19 2.41.45.96.25 2.04.61 3.15 1.07.55.24 1.13.48 1.68.76.57.28 1.16.6 1.67.87.59.34 1.11.66 1.64 1 .53.33 1.03.7 1.52 1.05.97.72 1.83 1.46 2.53 2.15.71.69 1.25 1.34 1.62 1.84.21.27.35.49.41.6.07.12.11.19.11.19.53.88.26 2.02-.62 2.56-.74.45-1.67.32-2.26-.24z"/></g></g></svg>

    </a>
    IREE
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/google/iree" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    google/iree
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../ml-frameworks/">ML frameworks</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="ML frameworks" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          ML frameworks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ml-frameworks/tensorflow/" class="md-nav__link">
        TensorFlow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ml-frameworks/tensorflow-lite/" class="md-nav__link">
        TensorFlow Lite
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ml-frameworks/jax/" class="md-nav__link">
        JAX
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../deployment-configurations/">Deployment configurations</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Deployment configurations" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Deployment configurations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment-configurations/cpu-dylib/" class="md-nav__link">
        CPU - Dylib
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment-configurations/bare-metal/" class="md-nav__link">
        CPU - Bare-Metal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment-configurations/gpu-vulkan/" class="md-nav__link">
        GPU - Vulkan
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../building-from-source/">Building from source</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Building from source" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Building from source
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../building-from-source/getting-started/" class="md-nav__link">
        Getting started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../building-from-source/optional-features/" class="md-nav__link">
        Optional features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../building-from-source/android/" class="md-nav__link">
        Android cross-compilation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../building-from-source/riscv/" class="md-nav__link">
        RISC-V cross-compilation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../bindings/">Bindings</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Bindings" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Bindings
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bindings/c-api/" class="md-nav__link">
        C API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bindings/python/" class="md-nav__link">
        Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bindings/tensorflow-lite/" class="md-nav__link">
        TensorFlow Lite
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          Community
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Community" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Community
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../community/projects/" class="md-nav__link">
        Projects
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Blog</a>
          
            <label for="__nav_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Blog" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-10-15-cuda-backend/" class="md-nav__link">
        CUDA backend
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Work in progress on Matrix Multiplication on CPU
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Work in progress on Matrix Multiplication on CPU
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#existing-matrix-multplication-code-generation" class="md-nav__link">
    Existing Matrix Multplication Code Generation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matrix-multiplication-operation-with-4d-tiled-operands" class="md-nav__link">
    Matrix Multiplication Operation With 4D Tiled Operands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-results" class="md-nav__link">
    Performance Results
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2021-07-19-tflite-tosa/" class="md-nav__link">
        TFLite Support via TOSA
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#existing-matrix-multplication-code-generation" class="md-nav__link">
    Existing Matrix Multplication Code Generation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matrix-multiplication-operation-with-4d-tiled-operands" class="md-nav__link">
    Matrix Multiplication Operation With 4D Tiled Operands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-results" class="md-nav__link">
    Performance Results
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <p>Wednesday, October 13, 2021<br>
By Ahmed Taei, Benoit Jacob</p>
<h1 id="work-in-progress-on-matrix-multiplication-on-cpu">Work in progress on Matrix Multiplication on CPU<a class="headerlink" href="#work-in-progress-on-matrix-multiplication-on-cpu" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p><a href="https://en.wikipedia.org/wiki/Matrix_multiplication">Matrix multiplication</a>
(matmul) is an important operation in ML workloads that poses specific
challenges to code generation. For example, matmul makes repeated accesses to
the same data, which makes
<a href="https://en.wikipedia.org/wiki/Locality_of_reference">locality of reference</a> a
top concern.</p>
<p>Moreover, modern CPUs
<a href="https://en.wikipedia.org/wiki/Instruction_set_architecture">instruction set architectures</a>
(ISAs) offer specialized <a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a> instructions
that the matmul implementation needs to use to achieve optimal performance, and
these instructions expect data to be in a particular layout.</p>
<p>This article is about an in-development MLIR operation,
<a href="https://github.com/llvm/llvm-project/blob/6e98ec9b2099475c057612a7af680a27c0b91a24/mlir/python/mlir/dialects/linalg/opdsl/ops/core_named_ops.py#L54-L71"><code>linalg.mmt4d</code></a>,
offering a compilation path for
<a href="https://github.com/llvm/llvm-project/blob/6e98ec9b2099475c057612a7af680a27c0b91a24/mlir/python/mlir/dialects/linalg/opdsl/ops/core_named_ops.py#L9-L21"><code>linalg.matmul</code></a>
that is designed from the ground up for these efficiency considerations.</p>
<p>We are still in the early implementation phase of this
<a href="https://github.com/llvm/llvm-project/blob/6e98ec9b2099475c057612a7af680a27c0b91a24/mlir/python/mlir/dialects/linalg/opdsl/ops/core_named_ops.py#L54-L71"><code>linalg.mmt4d</code></a>
plan, but we feel confident that we know where we are going because what we are
really doing here is importing into the compiler what we have learned working on
optimized matrix multiplication libraries, particularly
<a href="https://github.com/google/ruy">Ruy</a>. We know <em>what</em> loop schedule and kernel we
want the compiler to generate &mdash; essentially the same as we wrote in Ruy,
give or take additional optimizations such as
<a href="https://en.wikipedia.org/wiki/Loop_fission_and_fusion">fusions</a> and
<a href="https://en.wikipedia.org/wiki/Constant_folding">constant folding</a> that become
possible now that we are doing this within a compiler. This allows us to focus
on <em>how</em> we get the compiler to generate that schedule and kernel with purely
algebraic transformations that compose and enable further compiler
optimizations.</p>
<p>At the basis of this work is the
<a href="https://mlir.llvm.org/docs/Dialects/Linalg/OpDSL/">extensible op system of the Linalg dialect</a>
in the MLIR compiler toolkit. In this case, a general purpose, mixed precision
mmt4d op is defined via a high level description directly in the compiler and is
then available to both users of the compiler (as a <code>linalg.mmt4d</code> op) or for
direct emission via Python based IR construction (i.e. for direct integration
into high level frameworks without rebuilding the compiler). The ability to
define such new special forms cheaply, and without any systemic framework level
cost, is part of the extensibility and composition story that we expect will
become increasingly important in development and deployment scenarios in the
future, and in this case, it let us spring board off of high quality code
generation which was already well integrated and composed well with other
features of the compiler.</p>
<h2 id="existing-matrix-multplication-code-generation">Existing Matrix Multplication Code Generation<a class="headerlink" href="#existing-matrix-multplication-code-generation" title="Permanent link">&para;</a></h2>
<p>Let us start by discussing IREE’s existing matmul code generation and highlight
the issues that <code>mmt4d</code> aims to overcome.</p>
<p>The existing approach operates in-place on the source matrices. When we discuss
"tiling" in this paragraph, we refer exclusively to the traversal &mdash; how
these source matrices are traversed by the matmul loop. There is no "tiled
layout" here, which will be the key difference with <code>mmt4d</code> below.</p>
<p>The destination matrix is tiled into workgroups (CPU threads) tiles, then each
workgroup tile is tiled to fit some level of CPU cache, and finally each tile is
further tiled to fit target architecture registers (e.g. 8x8).</p>
<p>That multi-level tiling means that the code works like the following loop nest:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tiled_matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">tile_m</span><span class="p">,</span> <span class="n">tile_n</span><span class="p">,</span> <span class="n">tile_k</span><span class="p">,</span> <span class="n">tile_m_v</span><span class="p">,</span> <span class="n">tile_n_v</span><span class="p">,</span> <span class="n">tile_k_v</span><span class="p">):</span>
 <span class="n">m</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="n">k</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="n">n</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">tile_m</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">n1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">tile_n</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">tile_k</span><span class="p">):</span>
       <span class="c1"># First level of tiling views...</span>
       <span class="n">lhs_tile</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">m1</span><span class="p">:</span><span class="n">m1</span><span class="o">+</span><span class="n">tile_m</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k1</span><span class="o">+</span><span class="n">tile_k</span><span class="p">]</span>
       <span class="n">rhs_tile</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">k1</span><span class="p">:</span><span class="n">k1</span><span class="o">+</span><span class="n">tile_k</span><span class="p">,</span> <span class="n">n1</span><span class="p">:</span><span class="n">n1</span><span class="o">+</span><span class="n">tile_n</span><span class="p">]</span>
       <span class="n">dst_tile</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">m1</span><span class="p">:</span><span class="n">m1</span><span class="o">+</span><span class="n">tile_m</span><span class="p">,</span> <span class="n">n1</span><span class="p">:</span><span class="n">n1</span><span class="o">+</span><span class="n">tile_n</span><span class="p">]</span>
       <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tile_m</span><span class="p">,</span> <span class="n">tile_m_v</span><span class="p">):</span>
         <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tile_n</span><span class="p">,</span> <span class="n">tile_n_v</span><span class="p">):</span>
           <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tile_k</span><span class="p">,</span> <span class="n">tile_k_v</span><span class="p">):</span>
             <span class="c1"># Register tiling views...</span>
             <span class="n">lhs_tile_v</span> <span class="o">=</span> <span class="n">lhs_tile</span><span class="p">[</span><span class="n">mv</span><span class="p">:</span><span class="n">mv</span><span class="o">+</span><span class="n">tile_m_v</span><span class="p">,</span> <span class="n">kv</span><span class="p">:</span><span class="n">kv</span><span class="o">+</span><span class="n">tile_k_v</span><span class="p">]</span>
             <span class="n">rhs_tile_v</span> <span class="o">=</span> <span class="n">rhs_tile</span><span class="p">[</span><span class="n">kv</span><span class="p">:</span><span class="n">kv</span><span class="o">+</span><span class="n">tile_k_v</span><span class="p">,</span> <span class="n">nv</span><span class="p">:</span><span class="n">nv</span><span class="o">+</span><span class="n">tile_n_v</span><span class="p">]</span>
             <span class="c1"># kernel.</span>
             <span class="n">dst_tile</span><span class="p">[</span><span class="n">mv</span><span class="p">:</span><span class="n">mv</span><span class="o">+</span><span class="n">tile_m_v</span><span class="p">,</span> <span class="n">nv</span><span class="p">:</span><span class="n">nv</span><span class="o">+</span><span class="n">tile_n_v</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">lhs_tile_v</span><span class="p">,</span> <span class="n">rhs_tile_v</span><span class="p">)</span>
 <span class="k">return</span> <span class="n">C</span>
</code></pre></div>
<p>The two main problems with this approach are:</p>
<ul>
<li>
<p><strong>Overhead to meet SIMD ISA layout requirements</strong>: In practice, the kernel
    needs to use specific <a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a>
    instructions to perform the arithmetic. They expect small tiles of the
    matrices to be loaded in registers, in a specific layout. If the matrix data
    wasn't already stored in memory in such a tiled layout, then the kernel has
    to perform such a data rearrangement on the fly, incurring substantial
    overhead. For NxN matrix multiplication, the kernel performs
    O(N<sup>3</sup>) work on O(N<sup>2</sup>) data, so doing that rearrangement
    there means O(N<sup>3</sup>) overhead where O(N<sup>2</sup>) should have
    sufficed, as this could have been done as a pre-processing step on
    O(N<sup>2</sup>) data.</p>
</li>
<li>
<p><strong>Inefficent memory traversal:</strong> For efficiency reasons, we always need
    <code>tile_m_v&gt;1</code> and <code>tile_n_v&gt;1</code>. That is because the higher these values, the
    fewer memory-load instructions are needed overall; and this is also dictated
    by the SIMD instructions that we want to use. But that means that the kernel
    is accessing simultaneously multiple rows or columns of the left-hand and
    right-hand side matrices. And in this existing approach, they are stored in
    linear layout, not in a tiled layout, so these accesses are not contiguous
    in memory. This is detrimental to memory access performance, meaning the
    <a href="https://en.wikipedia.org/wiki/CPU_cache">CPU caches</a>, in multiple ways. One
    is that these multiple non-contiguous accesses may alias each other in the
    L1 cache because of low
    <a href="https://en.wikipedia.org/wiki/CPU_cache#Associativity">associativity</a>.</p>
</li>
</ul>
<h2 id="matrix-multiplication-operation-with-4d-tiled-operands">Matrix Multiplication Operation With 4D Tiled Operands<a class="headerlink" href="#matrix-multiplication-operation-with-4d-tiled-operands" title="Permanent link">&para;</a></h2>
<p>For the reasons above, an efficient matmul implementation must reorder data into
a tiled layout matching the target SIMD ISA and making the memory access
patterns as contiguous as possible.</p>
<p>IREE/MLIR defaults to bufferizing all tensors into a "row-major" order, meaning
that the last-enumerated dimension is the one that is contiguous in memory. As
we prefer not to write custom bufferization code, we can't specify an
alternative layout for a tensor. Fortunately, it is possible to represent a 2D
tiled layout as a 4D layout. For example, <code>tensor&lt;2x2x2x2xf32&gt;</code> can represent a
4x4 matrix made of 2x2 tiles, each of which is 2x2. The row-major layout on
<code>tensor&lt;2x2x2x2xf32&gt;</code> makes each 2x2 tile contiguous and row-major, and arranges
the 2x2 tiles themselves into a row-major 2x2 layout in the overall 4x4 matrix.</p>
<p>Such a row-major-tiled layout is exactly what we need for the left-hand side of
a matrix multiplication, because matrix multiplication traverses the left-hand
side matrix row by row. But for the right-hand side matrix, we want a
column-major-tiled layout. To solve this problem, we decide to implement not
matrix multiplication, but matrix-multiplication-by-transposed-right-hand-side
which is where the <code>t</code> in the <code>linalg.mmt4d</code> came from. Now such an op is happy
with both the left and right-hand sides being row-major-tiled.</p>
<p>The following example illustrates that. In these diagrams, each matrix element
is rendered its memory offset.</p>
<p><img alt="4x4-tiled" src="../2021-10-13-mmt4d-4x4_tiled.png" /></p>
<p>To compute the 2x2 block in the destination matrix, we will have to load two
yellow blocks from LHS, RHS matrices respectively compute their matmul results
(i.e. call the kernel), then the two blue blocks, and so on. As we can see, each
tile loads data that is not contiguous. It would be better if we rearranged the
elements in the following layout:</p>
<p><img alt="4x4-mmt4d" src="../2021-10-13-mmt4d-4x4_mmt4d.png" /></p>
<p>Now tiles are stored contiguously in memory and the kernel can simply load them
from memory into the registers that will be directly consumed by the SIMD
instructions performing the multiplications. Moreover, the kernel is now loading
from just two contiguous data streams, a simple memory access pattern which is
sure to be efficient (regarding caches, etc) on any reasonable target hardware.</p>
<p>We introduce a <code>linalg.mmt4d</code> operation that performs such a matrix
multiplication on matrices in a tiled layout represented as 4D tensors. That
leaves the question of how to represent, within the linalg dialect, the
conversions between ordinary matrices represented as 2D tensors, and these tiled
matrices represented as 4D tensors. Moreover, these conversions should be
tileable and decompose well. Thankfully, the transformation from 2D to 4D can be
written as a reshape followed by a transpose as in the following digram:</p>
<p><img alt="graphviz" src="../2021-10-13-mmt4d-graph_flow.svg" /></p>
<p>So we can think of the outermost two dimensions of the 4D representations as the
tile position in the overall matrix, and the innermost two as the element
position within one tile. Hopefully the following Python pseudocode makes it
more concrete:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pack_2d_4d</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">parallel_size</span><span class="p">,</span> <span class="n">reduction_size</span><span class="p">):</span>
 <span class="n">i1</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">parallel_size</span> <span class="c1"># M1</span>
 <span class="n">i2</span> <span class="o">=</span> <span class="n">parallel_size</span>    <span class="c1"># M0</span>
 <span class="n">j1</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">reduction_size</span> <span class="c1"># K1</span>
 <span class="n">j2</span> <span class="o">=</span> <span class="n">reduction_size</span>   <span class="c1"># K0</span>
 <span class="n">operand_4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">])</span>
 <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">operand_4d</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="c1"># [M1, K1, M0, K0]</span>
</code></pre></div>
<p>Now the mmt4d operation will will follow a structure as the multi level tiling,
for simplicity we considered the case here where no L1 tiling is required only
first level of distribution to workgroups:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">mmt4d</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">M0</span><span class="p">,</span> <span class="n">N0</span><span class="p">,</span> <span class="n">K0</span><span class="p">):</span>
 <span class="n">M</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="n">N</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="n">Bt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
 <span class="n">A4d</span> <span class="o">=</span> <span class="n">pack_2d_4d</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">M0</span><span class="p">,</span> <span class="n">K0</span><span class="p">)</span>
 <span class="n">Bt4d</span> <span class="o">=</span> <span class="n">pack_2d_4d</span><span class="p">(</span><span class="n">Bt</span><span class="p">,</span> <span class="n">N0</span><span class="p">,</span> <span class="n">K0</span><span class="p">)</span>
 <span class="n">M1</span> <span class="o">=</span> <span class="n">A4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="n">N1</span> <span class="o">=</span> <span class="n">Bt4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="n">K1</span> <span class="o">=</span> <span class="n">A4d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">M1</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">n1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N1</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">K1</span><span class="p">):</span>
       <span class="c1"># Tile views that are contiguous in memory.</span>
       <span class="n">lhs_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A4d</span><span class="p">[</span><span class="n">m1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="p">[</span><span class="n">M0</span><span class="p">,</span> <span class="n">K0</span><span class="p">])</span>
       <span class="n">rhs_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Bt4d</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="p">[</span><span class="n">N0</span><span class="p">,</span> <span class="n">K0</span><span class="p">])</span>
       <span class="c1"># Inner kernel.</span>
       <span class="n">C</span><span class="p">[</span><span class="n">m1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">lhs_tile</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">rhs_tile</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
 <span class="c1"># 4d -&gt; 2D</span>
 <span class="n">C2d</span> <span class="o">=</span> <span class="n">unpack_4d_2d</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
 <span class="k">return</span> <span class="n">C2d</span>
</code></pre></div>
<p>The resulting 4D tiled matrix still needs be rearranged back to the original
layout as 2D tensor:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">unpack_4d_2d</span><span class="p">(</span><span class="n">operand</span><span class="p">):</span>
 <span class="n">i1</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># M1</span>
 <span class="n">j1</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># N1</span>
 <span class="n">i2</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># M0</span>
 <span class="n">j2</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># N0</span>
 <span class="n">operand_transposed</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="c1"># [M1, M0, N1, N0]</span>
 <span class="k">return</span> <span class="n">operand_transposed</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">i1</span> <span class="o">*</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j1</span> <span class="o">*</span> <span class="n">j2</span><span class="p">])</span> <span class="c1"># [M, N]</span>
</code></pre></div>
<h2 id="performance-results">Performance Results<a class="headerlink" href="#performance-results" title="Permanent link">&para;</a></h2>
<p>We benchmarked various float32 matmul problems of different sizes and the result
showed that mmt4d is faster than the existing matmul implementation for bigger
matrices as we can see the in the following chart:</p>
<p><img alt="performance" src="../2021-10-13-mmt4d-mmt4d_vs_matmul.png" /></p>
<p>The SIMD instruction being used here is the simplest kind, a <code>vector*scalar</code>
multiplication, and the storage orders of the matrices allow the existing
implementation to directly load the vectors from the source matrices without any
rearrangement overhead. So this case is particularly friendly to the existing
code, which is why the mmt4d code is only faster for bigger matrices. To
understand why mmt4d is faster in that case, we collected statistics of L1 cache
misses:</p>
<p><img alt="load-misses" src="../2021-10-13-mmt4d-L1-dcache-load-misses.png" /></p>
<p>This shows that in this case, the better cache-friendliness of mmt4d, thanks to
its simple contiguous memory access pattern, accounts for its higher
performance.</p>
<p>As we proceed with increasingly sophisticated SIMD targets, starting with the
dot-product instructions found in current mobile devices for the int8 case and
going to become generalized to all data types all the way to float32 over the
next few years with upcoming ARM SIMD instructions, the advantage of mmt4d will
widen for all sizes, not just the larger ones.</p>
<p>Part of why we feel confident about the eventual performance that our approach
will achieve is that, as mentioned in the introduction, we are rebuilding within
the compiler an <a href="https://github.com/google/ruy">existing library</a>'s schedule and
kernel, and we have
<a href="https://docs.google.com/spreadsheets/d/1CB4gsI7pujNRAf5Iz5vuD783QQqO2zOu8up9IpTKdlU/edit?usp=sharing">benchmark results</a>
about it.</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>We introduced a 4d tiled representation for 2d matrix-matrix multiplication with
a decomposable algebric transformations that requires only reshape and transpose
of input operands, we discussed and empirically showed how that solves major
drawbacks in row-major linear matmul by providing a flexible way to match
different ISA layout along with better cache locality achieving near peak
performance.</p>
<p>As was mentioned in the introduction, this work in under active development and
the next immediate steps are to prove the rest of the hypothesis by:</p>
<ul>
<li>
<p>Handling dynamic sizes and padding to the next multiple of the target tile
    size.</p>
</li>
<li>
<p>Implementing the integer case (<code>int32 += int8 * int8</code>).</p>
</li>
<li>
<p>Implementing the dispatch to different SIMD ISA variants at runtime.</p>
</li>
<li>
<p>Implementing cache-friendly traversal for larger matmuls and multi-threading
    by interfacing with IREE's runtime dispatch.</p>
</li>
<li>
<p>Improving the generated code by fusing the 4d tiled layout with the
    producers and consumers of the <code>linalg.mmt4d</code>.</p>
</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        

<!-- Footer -->
<footer class="md-footer">

  <!-- The base theme links to previous and/or next page, we omit that here. -->

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">

      <!-- Copyright and theme information -->
      <div class="md-footer-copyright">
        
        <div class="md-footer-copyright__highlight">
          Copyright &copy; 2021 The IREE Authors
        </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>

      <!-- Social links -->
      
  <div class="md-footer-social">
    
      
      
      <a href="https://github.com/google/iree" target="_blank" rel="noopener" title="IREE on GitHub" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
      <a href="https://discord.gg/26P4xW4" target="_blank" rel="noopener" title="IREE Discord Server" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541zM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241z"/></svg>
      </a>
    
      
      
      <a href="https://groups.google.com/forum/#!forum/iree-discuss" target="_blank" rel="noopener" title="IREE Discuss Google Group" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M96 224c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm448 0c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm32 32h-64c-17.6 0-33.5 7.1-45.1 18.6 40.3 22.1 68.9 62 75.1 109.4h66c17.7 0 32-14.3 32-32v-32c0-35.3-28.7-64-64-64zm-256 0c61.9 0 112-50.1 112-112S381.9 32 320 32 208 82.1 208 144s50.1 112 112 112zm76.8 32h-8.3c-20.8 10-43.9 16-68.5 16s-47.6-6-68.5-16h-8.3C179.6 288 128 339.6 128 403.2V432c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48v-28.8c0-63.6-51.6-115.2-115.2-115.2zm-223.7-13.4C161.5 263.1 145.6 256 128 256H64c-35.3 0-64 28.7-64 64v32c0 17.7 14.3 32 32 32h65.9c6.3-47.4 34.9-87.3 75.2-109.4z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.top", "navigation.indexes"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>